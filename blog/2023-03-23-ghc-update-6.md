---
slug: 2023-03-23-ghc-update
title: "IOG GHC Update #6"
authors: [sylvain,doyougnu,luite,josh]
tags: [ghc,ghc-update]
---

Biweekly update from the GHC DevX team at IOG.

Previous updates can be found [here](https://engineering.iog.io/tags/ghc-update).

## JavaScript backend

### Port of GHCJS's Callback feature

Josh: opened an MR for porting GHCJS's `GHCJS.Foreign.Callback` module into the JavaScript backend.
The `Callback` type allows for passing Haskell functions into the FFI using standard JavaScript-styled
function arguments - where compiled functions usually use global variables as registers to pass arguments.
By passing functions into FFI imports and storing references to the functions, we can enable a form
of FFI "exports" - since the passed functions allow JavaScript code to call back into Haskell code.

This MR additionally adds user guide documentation for both callbacks, and general JavaScript FFI usage.

See the following links for more information:
* [GHC Issue](https://gitlab.haskell.org/ghc/ghc/-/issues/23126)
* [Merge Request](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10128)
* [CLC Proposal](https://github.com/haskell/core-libraries-committee/issues/150)

### Pipeline refactoring and new IR

Jeff: Began to lay the foundation for splitting the DSL in the JavaScript backend by segregating code generation to a new, basically identical DSL. The motivation is that by splitting the existing DSL, we can now replace the old DSL while still providing working builds. This is the first step in a multistep plan that eventually ends with GHCJS's optimizer and a typed sunroof based DSL. [MR is up] (https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10142)

### Faster weak references implementation?

Luite: investigated replacing heap traversal with newer JS feature (WeakRef, Finalizers)

### Testsuite and cleanup

Sylvain: removed dead code in the JS RTS [!10102](ttps://gitlab.haskell.org/ghc/ghc/-/merge_requests/10102)

Sylvain: did some triage of tests in GHC's testsuite failing with the JS backend. See tickets [#22370](https://gitlab.haskell.org/ghc/ghc/-/issues/22370), [#22374](https://gitlab.haskell.org/ghc/ghc/-/issues/22374), [#22576](https://gitlab.haskell.org/ghc/ghc/-/issues/22576), and merge requests [!10148](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10148), [!10150](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/10150).

## Miscellaneous

Jeff: Revived Data structure work in GHC.Unit.State resulting in -1.7% reduction in allocations (by geometric average) and -9% in some cases. [MR is here](https://gitlab.haskell.org/ghc/ghc/-/merge_requests/9702) and ready to land, just needs to upstream a single-line patch to haddock.
